name: Build

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: npm run build:frontend

      - name: Download ML models
        run: |
          rm -rf tagger  # Remove any symlink/file that might exist
          mkdir -p tagger/model

          echo "Downloading tagger model..."
          curl -L -o tagger/model/model.onnx \
            "https://huggingface.co/SmilingWolf/wd-vit-tagger-v3/resolve/main/model.onnx"
          curl -L -o tagger/model/selected_tags.csv \
            "https://huggingface.co/SmilingWolf/wd-vit-tagger-v3/resolve/main/selected_tags.csv"

          echo "Downloading YOLOv8n model..."
          curl -L -o yolov8n.pt \
            "https://github.com/ultralytics/assets/releases/download/v8.2.0/yolov8n.pt"

          ls -la tagger/model/ yolov8n.pt

      - name: Build Linux packages
        run: npx electron-builder --linux --publish never

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.zip
            dist/latest-linux.yml
          if-no-files-found: warn

  build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: npm run build:frontend

      - name: Download ML models
        run: |
          rm -rf tagger  # Remove any symlink/file that might exist
          mkdir -p tagger/model

          echo "Downloading tagger model..."
          curl -L -o tagger/model/model.onnx \
            "https://huggingface.co/SmilingWolf/wd-vit-tagger-v3/resolve/main/model.onnx"
          curl -L -o tagger/model/selected_tags.csv \
            "https://huggingface.co/SmilingWolf/wd-vit-tagger-v3/resolve/main/selected_tags.csv"

          echo "Downloading YOLOv8n model..."
          curl -L -o yolov8n.pt \
            "https://github.com/ultralytics/assets/releases/download/v8.2.0/yolov8n.pt"

          ls -la tagger/model/ yolov8n.pt

      - name: Build Mac packages
        run: npx electron-builder --mac --publish never

      - name: Upload Mac artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-builds
          path: |
            dist/*.dmg
            dist/*.zip
            dist/*.blockmap
            dist/latest-mac.yml
          if-no-files-found: warn

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: npm run build:frontend

      - name: Prepare Python bundle
        shell: pwsh
        run: |
          $PYTHON_VERSION = "3.11.9"
          $BUNDLE_DIR = "python-embed"

          Write-Host "Creating Python bundle directory..."
          New-Item -ItemType Directory -Force -Path $BUNDLE_DIR

          Write-Host "Downloading Python embeddable..."
          $pythonUrl = "https://www.python.org/ftp/python/$PYTHON_VERSION/python-$PYTHON_VERSION-embed-amd64.zip"
          Invoke-WebRequest -Uri $pythonUrl -OutFile "$BUNDLE_DIR\python.zip"

          Write-Host "Extracting Python..."
          Expand-Archive -Path "$BUNDLE_DIR\python.zip" -DestinationPath $BUNDLE_DIR -Force
          Remove-Item "$BUNDLE_DIR\python.zip"

          Write-Host "Enabling pip..."
          $pthFile = "$BUNDLE_DIR\python311._pth"
          $content = Get-Content $pthFile -Raw
          $content = $content -replace '#import site', 'import site'
          $content += "`nLib\site-packages`n"
          Set-Content -Path $pthFile -Value $content

          Write-Host "Installing pip..."
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "$BUNDLE_DIR\get-pip.py"
          & "$BUNDLE_DIR\python.exe" "$BUNDLE_DIR\get-pip.py"
          Remove-Item "$BUNDLE_DIR\get-pip.py"

          Write-Host "Installing dependencies..."
          # Install most dependencies (skip insightface which requires C++ build tools)
          & "$BUNDLE_DIR\python.exe" -m pip install fastapi uvicorn[standard] sqlalchemy aiosqlite pillow imagehash onnxruntime opencv-python-headless numpy pydantic pydantic-settings python-multipart httpx watchdog --no-warn-script-location

          # Try to install insightface (may fail on some systems, that's OK)
          Write-Host "Attempting to install insightface..."
          try {
            & "$BUNDLE_DIR\python.exe" -m pip install insightface --no-warn-script-location 2>&1 | Out-Null
          } catch {
            Write-Host "Note: insightface installation skipped (face detection will be unavailable)"
          }
          # Reset error state
          $LASTEXITCODE = 0

          Write-Host "Cleaning up..."
          Get-ChildItem -Path "$BUNDLE_DIR\Lib\site-packages" -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "$BUNDLE_DIR\Lib\site-packages" -Recurse -File -Filter "*.pyc" | Remove-Item -Force -ErrorAction SilentlyContinue

          Write-Host "Python bundle ready!"
          $size = (Get-ChildItem -Path $BUNDLE_DIR -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Bundle size: $([math]::Round($size, 2)) MB"

      - name: Download ML models
        shell: pwsh
        run: |
          # Remove any existing tagger symlink/file
          if (Test-Path "tagger") { Remove-Item -Recurse -Force "tagger" }
          New-Item -ItemType Directory -Force -Path "tagger/model"

          Write-Host "Downloading tagger model..."
          Invoke-WebRequest -Uri "https://huggingface.co/SmilingWolf/wd-vit-tagger-v3/resolve/main/model.onnx" -OutFile "tagger/model/model.onnx"
          Invoke-WebRequest -Uri "https://huggingface.co/SmilingWolf/wd-vit-tagger-v3/resolve/main/selected_tags.csv" -OutFile "tagger/model/selected_tags.csv"

          Write-Host "Downloading YOLOv8n model..."
          Invoke-WebRequest -Uri "https://github.com/ultralytics/assets/releases/download/v8.2.0/yolov8n.pt" -OutFile "yolov8n.pt"

          Get-ChildItem "tagger/model/"
          Get-ChildItem "yolov8n.pt"

      - name: Build Windows packages
        run: npx electron-builder --win --publish never

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            dist/*.exe
            dist/*.appx
            dist/*.blockmap
            dist/latest.yml
          if-no-files-found: warn

  release:
    needs: [build-linux, build-mac, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/linux-builds/*
            artifacts/mac-builds/*
            artifacts/windows-builds/*
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
