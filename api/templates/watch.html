<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LocalBooru - Watch Party</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a0a; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #fff; }
.watch-page { width: 100vw; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
.watch-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: rgba(0,0,0,0.8); border-bottom: 1px solid rgba(255,255,255,0.08); flex-shrink: 0; gap: 12px; }
.watch-title { color: rgba(255,255,255,0.9); font-size: 0.95rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
.watch-controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.watch-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
.badge-synced { background: rgba(76,175,80,0.2); color: #81c784; border: 1px solid rgba(76,175,80,0.3); }
.badge-disconnected { background: rgba(244,67,54,0.2); color: #ef9a9a; border: 1px solid rgba(244,67,54,0.3); }
.badge-buffering { background: rgba(255,152,0,0.2); color: #ffb74d; border: 1px solid rgba(255,152,0,0.3); }
.watch-video-container { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
video { width: 100%; height: 100%; object-fit: contain; background: #000; }
.watch-center { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: rgba(255,255,255,0.7); font-size: 1.1rem; }
.watch-center h2 { color: rgba(255,255,255,0.9); margin-bottom: 8px; }
.watch-center p { color: rgba(255,255,255,0.5); font-size: 0.9rem; }

/* Quality button */
.quality-btn {
  background: rgba(255,255,255,0.1);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 6px;
  padding: 4px 10px;
  font-size: 0.8rem;
  cursor: pointer;
  outline: none;
  display: flex;
  align-items: center;
  gap: 4px;
  font-family: inherit;
}
.quality-btn:hover { background: rgba(255,255,255,0.15); }
.quality-btn svg { width: 12px; height: 12px; }

/* Quality popup - matches host player QualitySelector.css */
.quality-backdrop {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 1998;
}
.quality-popup {
  position: fixed;
  top: 52px;
  right: 16px;
  background: rgba(30, 30, 30, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  z-index: 1999;
  min-width: 200px;
  animation: popupSlideIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
  overflow: hidden;
}
@keyframes popupSlideIn {
  from { opacity: 0; transform: translateY(-8px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.quality-popup-header {
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  font-weight: 600;
  font-size: 0.95rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.quality-options { display: flex; flex-direction: column; padding: 8px; }
.quality-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: transparent;
  border: none;
  color: rgba(255,255,255,0.8);
  cursor: pointer;
  border-radius: 6px;
  font-size: 0.9rem;
  text-align: left;
  font-family: inherit;
  transition: background 0.15s, color 0.15s;
}
.quality-option:hover { background: rgba(255,255,255,0.08); color: white; }
.quality-option.active { background: rgba(33,150,243,0.2); color: #64B5F6; }
.quality-option-content { display: flex; flex-direction: column; gap: 2px; flex: 1; }
.quality-label { font-weight: 600; font-size: 0.9rem; }
.quality-description { font-size: 0.75rem; opacity: 0.7; font-weight: normal; }
.quality-checkmark { width: 16px; height: 16px; color: #64B5F6; margin-left: 8px; flex-shrink: 0; }

/* Switching overlay */
.switching-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(255,255,255,0.8);
  font-size: 1rem;
  z-index: 10;
}

@media (max-width: 480px) {
  .quality-popup { top: 48px; right: 8px; min-width: 180px; }
  .quality-option { padding: 8px 10px; font-size: 0.85rem; }
  .quality-label { font-size: 0.85rem; }
  .quality-description { font-size: 0.7rem; }
}
</style>
</head>
<body>
<div class="watch-page" id="app">
  <div class="watch-center" id="loading">Connecting...</div>
</div>
<script>
(function() {
  var token = window.location.pathname.split('/watch/')[1];
  if (!token) { showError('Invalid share link'); return; }

  var base = window.location.origin;
  var video, hls, isSeeking = false;
  var hostState = null;
  var hostStateTime = 0;
  var hlsReady = false;
  var initialSynced = false;
  var currentQuality = 'original';
  var qualityPopupOpen = false;
  var sessionInfo = null;

  function showError(msg) {
    document.getElementById('app').innerHTML =
      '<div class="watch-center"><h2>Session Unavailable</h2><p>' + msg + '</p></div>';
  }

  function escapeHtml(s) {
    var d = document.createElement('div'); d.textContent = s; return d.innerHTML;
  }

  function getQualityLabel(id) {
    var labels = {
      original: 'Original',
      '1440p': '1440p',
      '1080p_enhanced': '1080p+',
      '1080p': '1080p',
      '720p': '720p',
      '480p': '480p'
    };
    return labels[id] || id;
  }

  // Quality presets (will be overridden by server response)
  var qualityPresets = [
    { id: 'original', label: 'Original', description: 'No transcoding' },
    { id: '1080p_enhanced', label: '1080p Enhanced', description: '20 Mbps' },
    { id: '1080p', label: '1080p', description: '12 Mbps' },
    { id: '720p', label: '720p', description: '8 Mbps' },
    { id: '480p', label: '480p', description: '4 Mbps' },
  ];

  function showPlayer(info) {
    sessionInfo = info;
    if (info.host_state) {
      hostState = info.host_state;
      hostStateTime = Date.now();
    }

    document.getElementById('app').innerHTML =
      '<div class="watch-header">' +
        '<span class="watch-title">' + escapeHtml(info.original_filename) + '</span>' +
        '<div class="watch-controls">' +
          '<button class="quality-btn" id="qualityBtn">' +
            '<span id="qualityLabel">' + getQualityLabel(currentQuality) + '</span>' +
            '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>' +
          '</button>' +
          '<span class="watch-badge badge-buffering" id="badge">Buffering...</span>' +
        '</div>' +
      '</div>' +
      '<div class="watch-video-container" id="videoContainer">' +
        '<video id="video" controls playsinline></video>' +
      '</div>';

    video = document.getElementById('video');
    document.getElementById('qualityBtn').addEventListener('click', toggleQualityPopup);
    startPlayback(currentQuality);
    startSync();
  }

  function toggleQualityPopup() {
    if (qualityPopupOpen) {
      closeQualityPopup();
    } else {
      openQualityPopup();
    }
  }

  function openQualityPopup() {
    closeQualityPopup(); // Clean up any existing
    qualityPopupOpen = true;

    var backdrop = document.createElement('div');
    backdrop.className = 'quality-backdrop';
    backdrop.id = 'qualityBackdrop';
    backdrop.addEventListener('click', closeQualityPopup);

    var popup = document.createElement('div');
    popup.className = 'quality-popup';
    popup.id = 'qualityPopup';
    popup.addEventListener('click', function(e) { e.stopPropagation(); });

    var header = document.createElement('div');
    header.className = 'quality-popup-header';
    header.textContent = 'Quality';
    popup.appendChild(header);

    var options = document.createElement('div');
    options.className = 'quality-options';

    qualityPresets.forEach(function(preset) {
      var btn = document.createElement('button');
      btn.className = 'quality-option' + (currentQuality === preset.id ? ' active' : '');
      btn.innerHTML =
        '<div class="quality-option-content">' +
          '<span class="quality-label">' + escapeHtml(preset.label) + '</span>' +
          '<span class="quality-description">' + escapeHtml(preset.description) + '</span>' +
        '</div>' +
        (currentQuality === preset.id
          ? '<svg class="quality-checkmark" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>'
          : '');
      btn.addEventListener('click', function() {
        selectQuality(preset.id);
      });
      options.appendChild(btn);
    });

    popup.appendChild(options);
    document.body.appendChild(backdrop);
    document.body.appendChild(popup);
  }

  function closeQualityPopup() {
    qualityPopupOpen = false;
    var backdrop = document.getElementById('qualityBackdrop');
    var popup = document.getElementById('qualityPopup');
    if (backdrop) backdrop.remove();
    if (popup) popup.remove();
  }

  function selectQuality(qualityId) {
    closeQualityPopup();
    if (qualityId === currentQuality) return;

    var pos = video ? video.currentTime : 0;
    var wasPlaying = video ? !video.paused : false;

    // Show switching overlay
    var container = document.getElementById('videoContainer');
    var overlay = document.createElement('div');
    overlay.className = 'switching-overlay';
    overlay.id = 'switchingOverlay';
    overlay.textContent = 'Switching quality...';
    container.appendChild(overlay);

    stopPlayback();

    // Request server to switch transcode quality
    fetch(base + '/api/share/' + token + '/quality', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ quality: qualityId })
    })
    .then(function(r) {
      if (!r.ok) throw new Error('Quality change failed');
      return r.json();
    })
    .then(function() {
      currentQuality = qualityId;
      // Update button label
      var label = document.getElementById('qualityLabel');
      if (label) label.textContent = getQualityLabel(qualityId);

      // Wait a moment for FFmpeg to start producing segments
      setTimeout(function() {
        startPlayback(qualityId, pos, wasPlaying);
        // Remove overlay once video starts playing
        var removeOverlay = function() {
          var ov = document.getElementById('switchingOverlay');
          if (ov) ov.remove();
        };
        if (video) {
          video.addEventListener('playing', removeOverlay, { once: true });
          video.addEventListener('loadeddata', removeOverlay, { once: true });
          // Fallback: remove after 10s
          setTimeout(removeOverlay, 10000);
        }
      }, 2000);
    })
    .catch(function(err) {
      console.error('[Watch] Quality change failed:', err);
      var ov = document.getElementById('switchingOverlay');
      if (ov) ov.textContent = 'Quality change failed';
      setTimeout(function() {
        var ov2 = document.getElementById('switchingOverlay');
        if (ov2) ov2.remove();
        // Restart with previous quality
        startPlayback(currentQuality, pos, wasPlaying);
      }, 2000);
    });
  }

  function stopPlayback() {
    if (hls) { hls.destroy(); hls = null; }
    if (video) { video.pause(); video.removeAttribute('src'); video.load(); }
    hlsReady = false;
  }

  function startPlayback(quality, seekTo, autoplay) {
    var hlsUrl = base + '/api/share/' + token + '/hls/playlist.m3u8';
    var startPos = seekTo || ((hostState && hostState.position) ? hostState.position : 0);

    if (Hls.isSupported()) {
      hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        startPosition: startPos,
      });
      hls.loadSource(hlsUrl);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        hlsReady = true;
        if (seekTo > 0) video.currentTime = seekTo;
        else if (!initialSynced) doInitialSync();
        if (autoplay) video.play().catch(function(){});
      });
      hls.on(Hls.Events.ERROR, function(_, data) {
        if (data.fatal && data.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = hlsUrl;
      video.addEventListener('loadedmetadata', function onMeta() {
        video.removeEventListener('loadedmetadata', onMeta);
        hlsReady = true;
        if (seekTo > 0) video.currentTime = seekTo;
        else if (!initialSynced) doInitialSync();
        if (autoplay) video.play().catch(function(){});
      });
    }
  }

  function doInitialSync() {
    if (initialSynced || !hlsReady || !video || !hostState) return;
    initialSynced = true;
    if (hostState.position > 2) video.currentTime = hostState.position;
    if (hostState.playing) video.play().catch(function(){});
    if (hostState.speed) video.playbackRate = hostState.speed;
    setBadge('synced', 'Synced');
  }

  function startSync() {
    var es = new EventSource(base + '/api/share/' + token + '/events');
    es.onmessage = function(e) {
      try {
        var evt = JSON.parse(e.data);
        if (evt.type === 'sync') {
          hostState = evt.data || evt;
          hostStateTime = Date.now();
          if (initialSynced) applySync(hostState);
          else doInitialSync();
        } else if (evt.type === 'disconnected') {
          setBadge('disconnected', 'Host disconnected');
          es.close();
        }
      } catch(err) {}
    };
    es.onerror = function() {
      setBadge('buffering', 'Reconnecting...');
    };

    // Periodic drift check every 3s
    setInterval(function() {
      if (!video || !hostState || !initialSynced || isSeeking) return;
      var elapsed = (Date.now() - hostStateTime) / 1000;
      var speed = hostState.speed || 1;
      var estimatedPos = hostState.position + (hostState.playing ? elapsed * speed : 0);
      var drift = Math.abs(video.currentTime - estimatedPos);

      if (hostState.playing && video.paused) video.play().catch(function(){});
      else if (!hostState.playing && !video.paused) video.pause();

      if (drift > 3) video.currentTime = estimatedPos;
    }, 3000);
  }

  function applySync(state) {
    if (!video || isSeeking) return;

    if (state.speed !== undefined && video.playbackRate !== state.speed) {
      video.playbackRate = state.speed;
    }

    if (state.position !== undefined) {
      var drift = Math.abs(video.currentTime - state.position);
      if (drift > 1) {
        isSeeking = true;
        video.currentTime = state.position;
        setTimeout(function() { isSeeking = false; }, 500);
      }
    }

    if (state.playing !== undefined) {
      if (state.playing && video.paused) video.play().catch(function(){});
      else if (!state.playing && !video.paused) video.pause();
    }

    setBadge('synced', 'Synced');
  }

  function setBadge(type, text) {
    var b = document.getElementById('badge');
    if (b) { b.className = 'watch-badge badge-' + type; b.textContent = text; }
  }

  // Load session info
  fetch(base + '/api/share/' + token + '/info')
    .then(function(r) { if (!r.ok) throw new Error(r.status); return r.json(); })
    .then(showPlayer)
    .catch(function() { showError('Session not found or expired'); });
})();
</script>
</body>
</html>
